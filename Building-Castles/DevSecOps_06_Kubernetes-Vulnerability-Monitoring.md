# Exercise | Implement a Vulnerability Monitor using the Trivy operator

1. First of all you'll need to install the [Trivy Operator](https://github.com/aquasecurity/trivy-operator) on your Kubernetes cluster.
   As simple as:

   ```console
   > kubectl apply -f https://raw.githubusercontent.com/aquasecurity/trivy-operator/v0.14.1/deploy/static/trivy-operator.yaml
   customresourcedefinition.apiextensions.k8s.io/clustercompliancereports.aquasecurity.github.io configured
   customresourcedefinition.apiextensions.k8s.io/clusterconfigauditreports.aquasecurity.github.io configured
   customresourcedefinition.apiextensions.k8s.io/clusterinfraassessmentreports.aquasecurity.github.io configured
   customresourcedefinition.apiextensions.k8s.io/clusterrbacassessmentreports.aquasecurity.github.io configured
   customresourcedefinition.apiextensions.k8s.io/configauditreports.aquasecurity.github.io configured
   customresourcedefinition.apiextensions.k8s.io/exposedsecretreports.aquasecurity.github.io configured
   customresourcedefinition.apiextensions.k8s.io/infraassessmentreports.aquasecurity.github.io configured
   customresourcedefinition.apiextensions.k8s.io/rbacassessmentreports.aquasecurity.github.io configured
   customresourcedefinition.apiextensions.k8s.io/vulnerabilityreports.aquasecurity.github.io configured
   namespace/trivy-system configured
   secret/trivy-operator created
   secret/trivy-operator-trivy-config created
   configmap/trivy-operator created
   configmap/trivy-operator-trivy-config created
   deployment.apps/trivy-operator created
   role.rbac.authorization.k8s.io/trivy-operator-leader-election created
   rolebinding.rbac.authorization.k8s.io/trivy-operator-leader-election created
   configmap/trivy-operator-policies-config created
   serviceaccount/trivy-operator created
   clusterrole.rbac.authorization.k8s.io/trivy-operator configured
   clusterrole.rbac.authorization.k8s.io/aggregate-config-audit-reports-view unchanged
   clusterrole.rbac.authorization.k8s.io/aggregate-exposed-secret-reports-view unchanged
   clusterrole.rbac.authorization.k8s.io/aggregate-vulnerability-reports-view unchanged
   clusterrolebinding.rbac.authorization.k8s.io/trivy-operator unchanged
   role.rbac.authorization.k8s.io/trivy-operator created
   rolebinding.rbac.authorization.k8s.io/trivy-operator created
   service/trivy-operator created
   ```

2. The testing environment will be a namespace called `myns` with a specific
   label that will activate reports:

   ```console
   > kubectl create namespace myns
   namespace/myns created

   > kubectl label namespaces myns trivy-operator-validation=true
   namespace/myns labeled

   > kubectl label namespaces myns trivy-scan=true
   namespace/myns labeled

   > kubectl describe namespaces myns
   Name:         myns
   Labels:       kubernetes.io/metadata.name=myns
                 trivy-operator-validation=true
                 trivy-scan=true
   Annotations:  <none>
   Status:       Active

   No resource quota.

   No LimitRange resource.
   ```

   To begin the test create a deployment with a container affected with knwon
   CRITICAL issues, like `nginx:1.18`:

   ```console
   > kubectl -n myns create deployment nginx --image public.ecr.aws/nginx/nginx:1.18
   deployment.apps/nginx created
   ```

   After some time, two additional resources should have been created:

   ```console
   rasca@catastrofe [~]> kubectl -n myns get all,vulnerabilityreport,configauditreport
   NAME                         READY   STATUS    RESTARTS   AGE
   pod/nginx-5778d6df55-5czx7   1/1     Running   0          46s

   NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
   deployment.apps/nginx   1/1     1            1           46s

   NAME                               DESIRED   CURRENT   READY   AGE
   replicaset.apps/nginx-5778d6df55   1         1         1       46s

   NAME                                                                           REPOSITORY      TAG    SCANNER   AGE
   vulnerabilityreport.aquasecurity.github.io/replicaset-nginx-5778d6df55-nginx   library/nginx   1.16   Trivy     25s

   NAME                                                                   SCANNER   AGE
   configauditreport.aquasecurity.github.io/replicaset-nginx-5778d6df55   Trivy     46s
   ```

   Details about the analysis can be described as follows:

   ```console
   > kubectl -n myns describe configauditreport.aquasecurity.github.io/replicaset-nginx-7d79b97979
   Name:         replicaset-nginx-7d79b97979
   Namespace:    myns
   Labels:       plugin-config-hash=659b7b9c46
                 resource-spec-hash=5c4c6c67f7
                 trivy-operator.resource.kind=ReplicaSet
                 trivy-operator.resource.name=nginx-7d79b97979
                 trivy-operator.resource.namespace=myns
   Annotations:  trivy-operator.aquasecurity.github.io/report-ttl: 24h0m0s
   API Version:  aquasecurity.github.io/v1alpha1
   Kind:         ConfigAuditReport
   Metadata:
     Creation Timestamp:  2023-07-06T15:48:02Z
     Generation:          1
     Owner References:
       API Version:           apps/v1
       Block Owner Deletion:  false
       Controller:            true
       Kind:                  ReplicaSet
       Name:                  nginx-7d79b97979
       UID:                   d97bdf70-fd9b-407b-b40d-9f21ccb150e5
     Resource Version:        185067
     UID:                     8a9e4889-cafd-470f-a13f-c2f0a0c95c55
   Report:
     Checks:
       Category:     Kubernetes Security Check
       Check ID:     KSV021
       Description:  Force the container to run with group ID > 10000 to avoid conflicts with the hostâ€™s user table.
       Messages:
         Container 'nginx' of ReplicaSet 'nginx-7d79b97979' should set 'securityContext.runAsGroup' > 10000
       Severity:     LOW
       Success:      false
       Title:        Runs with low group ID
       Category:     Kubernetes Security Check
       ...
       ...
       Check ID:     KSV012
       Description:  'runAsNonRoot' forces the running image to run as a non-root user to ensure least privileges.
       Messages:
         Container 'nginx' of ReplicaSet 'nginx-7d79b97979' should set 'securityContext.runAsNonRoot' to true
       Severity:     MEDIUM
       Success:      false
       Title:        Runs as root user
       Category:     Kubernetes Security Check
     Summary:
       Critical Count:  0
       High Count:      0
       Low Count:       10
       Medium Count:    2
     Update Timestamp:  2023-07-06T15:48:02Z
   Events:              <none>
   ```

3. Bonus: activate useful utilities with `kubectl`:

   - Install krew:

   ```console
   > tar -xzvf Downloads/krew-linux_amd64.tar.gz
   > sudo mv krew-linux_amd64 /usr/local/bin/krew
   > krew install krew
   Adding "default" plugin index from https://github.com/kubernetes-sigs/krew-index.git.
   Updated the local copy of plugin index.
   Installing plugin: krew
   Installed plugin: krew
   \
    | Use this plugin:
    | 	kubectl krew
    | Documentation:
    | 	https://krew.sigs.k8s.io/
    | Caveats:
    | \
    |  | krew is now installed! To start using kubectl plugins, you need to add
    |  | krew's installation directory to your PATH:
    |  |
    |  |   * macOS/Linux:
    |  |     - Add the following to your ~/.bashrc or ~/.zshrc:
    |  |         export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
    |  |     - Restart your shell.
    |  |
    |  |   * Windows: Add %USERPROFILE%\.krew\bin to your PATH environment variable
    |  |
    |  | To list krew commands and to get help, run:
    |  |   $ kubectl krew
    |  | For a full list of available plugins, run:
    |  |   $ kubectl krew search
    |  |
    |  | You can find documentation at
    |  |   https://krew.sigs.k8s.io/docs/user-guide/quickstart/.
    | /
   /
   ```

   Install `who-can` and `tree` kubectl plugins:

   ```console
   > kubectl krew install who-can
   ...

   > kubectl krew install tree
   ...
   ```

   List who can list vulnerabilityreports

   ```console
   > kubectl who-can list vulnerabilityreports
   No subjects found with permissions to list vulnerabilityreports assigned through RoleBindings

   CLUSTERROLEBINDING                           SUBJECT                         TYPE            SA-NAMESPACE
   cluster-admin                                system:masters                  Group
   dashboard-viewer-rolebinding                 dashboard-user                  ServiceAccount  kubernetes-dashboard
   system:controller:generic-garbage-collector  generic-garbage-collector       ServiceAccount  kube-system
   system:controller:namespace-controller       namespace-controller            ServiceAccount  kube-system
   system:controller:resourcequota-controller   resourcequota-controller        ServiceAccount  kube-system
   system:kube-controller-manager               system:kube-controller-manager  User
   trivy-operator                               trivy-operator                  ServiceAccount  trivy-system
   ```
