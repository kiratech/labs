# Policy Reporter - Visualizing Kyverno Policies

Policy Reporter is a monitoring and observability tool for Kubernetes that
visualizes PolicyReport CRDs generated by Kyverno and other policy engines.

It provides a web UI, Prometheus metrics integration, and notification support
for Slack, Discord, MS Teams, and more, helping teams understand policy
compliance across their clusters.

Check [the official Policy Reporter documentation](https://kyverno.github.io/policy-reporter-docs/)
and [Kyverno documentation](https://kyverno.io/docs/) for more details.

## Requisites

Policy Reporter requires Kyverno to be installed and running in your cluster.
If you haven't completed Stage 2, install Kyverno first

**Important**: For Kubernetes 1.29 or older, use Kyverno version 3.1.4 or
earlier to avoid compatibility issues with ValidatingAdmissionPolicy APIs.

## Installing Policy Reporter

Add the Policy Reporter Helm repository and install it with UI and Kyverno
plugin enabled:

```console
$ helm repo add policy-reporter https://kyverno.github.io/policy-reporter
"policy-reporter" has been added to your repositories

$ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "policy-reporter" chart repository
Update Complete. ⎈Happy Helming!⎈

$ helm install policy-reporter policy-reporter/policy-reporter \
    --create-namespace -n policy-reporter \
    --set ui.enabled=true \
    --set kyvernoPlugin.enabled=true \
    --set ui.plugins.kyverno=true
NAME: policy-reporter
LAST DEPLOYED: Thu Dec 19 17:05:00 2025
NAMESPACE: policy-reporter
STATUS: deployed
REVISION: 1
...

$ kubectl get pods -n policy-reporter
NAME                                    READY   STATUS    RESTARTS   AGE
policy-reporter-7d6b5c8f9d-4xzmh       1/1     Running   0          45s
policy-reporter-ui-5f7b9d6c8d-2pqrt    1/1     Running   0          45s
```

## Testing Policy Reports

You can use the provided script to automatically create test policies and pods:

```console
$ chmod +x stage-4-policy-reporter-visualization.sh
(no output)

$ ./stage-4-policy-reporter-visualization.sh

═══════════════════════════════════════════════════════════
  Stage 4: Policy Reporter Visualization - Testing
═══════════════════════════════════════════════════════════

ℹ Checking prerequisites...
✓ Prerequisites check passed

═══════════════════════════════════════════════════════════
  Creating Test Environment
═══════════════════════════════════════════════════════════

ℹ Creating namespace policy-test...
namespace/policy-test created
✓ Namespace created
...
```

The script creates two ClusterPolicies and three test pods to demonstrate policy
violations and compliant resources.

## Viewing Policy Reports

After the test script runs, Kyverno generates PolicyReports for the resources:

```console
$ kubectl get policyreport -n policy-test
NAME                                   KIND   NAME                           PASS   FAIL   WARN   ERROR   SKIP   AGE
5d653b12-8fe9-4e17-8464-551f35fb76d5   Pod    non-compliant-missing-labels   2      1      0      0       0      7s
843dab32-08bc-41de-9af3-1234a84a365e   Pod    non-compliant-latest-tag       2      1      0      0       0      7s
d7908844-98a5-446a-a170-8faacfdb2741   Pod    compliant-pod                  3      0      0      0       0      8s

kubectl -n policy-test describe policyreport 5d653b12-8fe9-4e17-8464-551f35fb76d5
Name:         5d653b12-8fe9-4e17-8464-551f35fb76d5
Namespace:    policy-test
Labels:       app.kubernetes.io/managed-by=kyverno
Annotations:  <none>
API Version:  wgpolicyk8s.io/v1alpha2
Kind:         PolicyReport
Metadata:
  Creation Timestamp:  2025-12-19T16:46:07Z
  Generation:          2
  Owner References:
    API Version:     v1
    Kind:            Pod
    Name:            non-compliant-missing-labels
    UID:             5d653b12-8fe9-4e17-8464-551f35fb76d5
  Resource Version:  20117
  UID:               5b938b66-b135-4427-860c-35f8711f7f30
Results:
  Category:  Best Practices
  Message:   validation rule 'require-image-tag' passed.
  Policy:    disallow-latest-tag
  Result:    pass
  Rule:      require-image-tag
  Scored:    true
  Severity:  medium
  Source:    kyverno
  Timestamp:
    Nanos:    0
    Seconds:  1766162787
  Category:   Best Practices
  Message:    validation rule 'require-image-tag-initcontainers' passed.
  Policy:     disallow-latest-tag
  Result:     pass
  Rule:       require-image-tag-initcontainers
  Scored:     true
  Severity:   medium
  Source:     kyverno
  Timestamp:
    Nanos:    0
    Seconds:  1766162787
  Category:   Best Practices
  Message:    validation error: Pods must have 'app' and 'owner' labels. rule check-for-labels failed at path /metadata/labels/owner/
  Policy:     require-labels
  Result:     fail
  Rule:       check-for-labels
  Scored:     true
  Severity:   medium
  Source:     kyverno
  Timestamp:
    Nanos:    0
    Seconds:  1766162787
Scope:
  API Version:  v1
  Kind:         Pod
  Name:         non-compliant-missing-labels
  Namespace:    policy-test
  UID:          5d653b12-8fe9-4e17-8464-551f35fb76d5
Summary:
  Error:  0
  Fail:   1
  Pass:   2
  Skip:   0
  Warn:   0
Events:   <none>
...
```

## Accessing the Policy Reporter UI

Start a port forward to access the web UI:

```console
$ kubectl port-forward -n policy-reporter svc/policy-reporter-ui 8082:8080
Forwarding from 127.0.0.1:8082 -> 8080
Forwarding from [::1]:8082 -> 8080
```

Open your browser and navigate to `http://localhost:8082`.

The UI provides:

- **Dashboard**: Overview of all policy results with pass/fail/warn/error counts
- **Policy Dashboard**: Detailed view filtered by namespace, policy, and severity
- **Kyverno**: Enhanced policy details with annotations and exceptions

## Cleanup

### Using the Script

The test script includes an interactive cleanup option at the end. If you didn't
run cleanup during the script execution, you can manually clean up:

```console
$ kubectl delete pod -n policy-test --all
pod "compliant-pod" deleted
pod "non-compliant-latest-tag" deleted
pod "non-compliant-missing-labels" deleted

$ kubectl delete clusterpolicy require-labels disallow-latest-tag
clusterpolicy.kyverno.io "require-labels" deleted
clusterpolicy.kyverno.io "disallow-latest-tag" deleted

$ kubectl delete namespace policy-test
namespace "policy-test" deleted
```

### Manual Cleanup

To remove Policy Reporter:

```console
$ helm uninstall policy-reporter -n policy-reporter
release "policy-reporter" uninstalled

$ kubectl delete namespace policy-reporter
namespace "policy-reporter" deleted
```

## Troubleshooting

### Kyverno admission controller not ready

If Kyverno's admission controller pod shows `0/1 READY`, it may be having TLS
certificate issues. This is common on Kind clusters:

```console
$ kubectl get pods -n kyverno
NAME                                            READY   STATUS    RESTARTS   AGE
kyverno-admission-controller-6bd675cdb7-7m8c2   0/1     Running   1          3m
kyverno-background-controller-5c7f9889d-7dfkn   1/1     Running   0          3m
kyverno-cleanup-controller-59c4b88dbc-6lpp2     1/1     Running   0          3m
kyverno-reports-controller-856b76d78d-2rq5f     1/1     Running   0          3m

$ kubectl logs -n kyverno kyverno-admission-controller-6bd675cdb7-7m8c2 | grep TLS
http: TLS handshake error: secret "kyverno-svc.kyverno.svc.kyverno-tls-pair" not found
```

Solution: Reinstall Kyverno with more tolerant health probes:

```console
$ helm uninstall kyverno -n kyverno
release "kyverno" uninstalled

$ helm install kyverno kyverno/kyverno -n kyverno \
    --create-namespace --version 3.1.4 \
    --set admissionController.startupProbe.failureThreshold=30 \
    --set admissionController.startupProbe.periodSeconds=10
...
```

### No policy reports showing

If `kubectl get policyreport` returns no results, verify that:

Kyverno reports controller is running:

```console
$ kubectl get pods -n kyverno -l app.kubernetes.io/component=reports-controller
NAME                                          READY   STATUS    RESTARTS   AGE
kyverno-reports-controller-856b76d78d-2rq5f   1/1     Running   0          5m
```

PolicyReport CRDs are installed:

```console
$ kubectl get crd | grep policyreport
clusterpolicyreports.wgpolicyk8s.io       2025-12-19T15:25:04Z
policyreports.wgpolicyk8s.io              2025-12-19T15:25:04Z
```

Policies are in Audit mode (not Enforce) and have `background: true`:

```console
$ kubectl get clusterpolicy require-labels -o yaml | grep -A 2 "spec:"
spec:
  background: true
  validationFailureAction: Audit
```

If reports still don't appear, recreate the resources to trigger evaluation:

```console
$ kubectl delete pod -n policy-test --all
pod "compliant-pod" deleted

$ kubectl apply -f your-test-pods.yaml
pod/compliant-pod created
```

### Compatibility errors with ValidatingAdmissionPolicy

If you see errors like `failed to list *v1.ValidatingAdmissionPolicy` in
Kyverno logs, your Kyverno version is too new for your Kubernetes cluster:

```console
$ kubectl logs -n kyverno -l app.kubernetes.io/component=reports-controller | grep ValidatingAdmission
Failed to watch error="failed to list *v1.ValidatingAdmissionPolicyBinding: the server could not find the requested resource"
```

Solution: Downgrade to a compatible version (see Requisites section above)